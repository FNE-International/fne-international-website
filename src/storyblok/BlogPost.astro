---
import { storyblokEditable, renderRichText } from '@storyblok/astro';
import { formatDate, getCategoryLabel, getCategoryColors, getOptimizedImageUrl } from '../lib/storyblok';

interface Props {
  blok: {
    title: string;
    slug: string;
    featured_image: {
      filename: string;
      alt?: string;
    };
    excerpt: string;
    author_name: string;
    author_image?: {
      filename: string;
      alt?: string;
    };
    publish_date: string;
    category: string;
    content: unknown;
    featured?: boolean;
  };
}

const { blok } = Astro.props;
const renderedContent = blok.content ? renderRichText(blok.content) : '';
const categoryColors = getCategoryColors(blok.category || 'stories');
---

<article {...storyblokEditable(blok)} class="blog-post">
  <!-- Hero Section -->
  <header class="relative">
    <!-- Featured Image -->
    <div class="relative h-[50vh] min-h-[400px] max-h-[600px] overflow-hidden">
      <img
        src={getOptimizedImageUrl(blok.featured_image?.filename, { width: 1600 })}
        alt={blok.featured_image?.alt || blok.title}
        class="w-full h-full object-cover"
      />
      <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
    </div>

    <!-- Title overlay -->
    <div class="absolute bottom-0 left-0 right-0 pb-12">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Category Badge -->
        <span class={`inline-block px-3 py-1 rounded-full text-sm font-medium mb-4 ${categoryColors.bg} ${categoryColors.text}`}>
          {getCategoryLabel(blok.category)}
        </span>

        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-4 leading-tight">
          {blok.title}
        </h1>

        <!-- Meta info -->
        <div class="flex flex-wrap items-center gap-4 text-white/90">
          <!-- Author -->
          <div class="flex items-center gap-3">
            {blok.author_image?.filename ? (
              <img
                src={getOptimizedImageUrl(blok.author_image.filename, { width: 48, height: 48 })}
                alt={blok.author_name || 'Author'}
                class="w-10 h-10 rounded-full object-cover border-2 border-white/30"
              />
            ) : (
              <div class="w-10 h-10 rounded-full bg-[#2D8B4E] flex items-center justify-center text-white font-semibold">
                {blok.author_name?.charAt(0) || 'A'}
              </div>
            )}
            <span class="font-medium">{blok.author_name || 'Anonymous'}</span>
          </div>

          <span class="text-white/50">â€¢</span>

          <!-- Date -->
          <time datetime={blok.publish_date} class="text-white/80">
            {formatDate(blok.publish_date)}
          </time>
        </div>
      </div>
    </div>
  </header>

  <!-- Content -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Excerpt -->
    <p class="text-xl md:text-2xl text-gray-600 leading-relaxed mb-8 font-light border-l-4 border-[#2D8B4E] pl-6">
      {blok.excerpt}
    </p>

    <!-- Main content -->
    <div class="prose prose-lg max-w-none blog-content" set:html={renderedContent} />

    <!-- Author bio -->
    <div class="mt-12 pt-8 border-t border-gray-200">
      <div class="flex items-center gap-4">
        {blok.author_image?.filename ? (
          <img
            src={getOptimizedImageUrl(blok.author_image.filename, { width: 80, height: 80 })}
            alt={blok.author_name}
            class="w-16 h-16 rounded-full object-cover"
          />
        ) : (
          <div class="w-16 h-16 rounded-full bg-[#2D8B4E] flex items-center justify-center text-white font-bold text-xl">
            {blok.author_name.charAt(0)}
          </div>
        )}
        <div>
          <p class="text-sm text-gray-500 uppercase tracking-wide">Written by</p>
          <p class="text-lg font-semibold text-gray-900">{blok.author_name}</p>
        </div>
      </div>
    </div>
  </div>
</article>

<style>
  /* Rich text content styling */
  .blog-content :global(h2) {
    font-size: 1.875rem;
    line-height: 2.25rem;
    font-weight: 700;
    color: #111827;
    margin-top: 3rem;
    margin-bottom: 1.5rem;
  }

  .blog-content :global(h3) {
    font-size: 1.5rem;
    line-height: 2rem;
    font-weight: 700;
    color: #111827;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  .blog-content :global(h4) {
    font-size: 1.25rem;
    line-height: 1.75rem;
    font-weight: 600;
    color: #111827;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .blog-content :global(p) {
    color: #374151;
    line-height: 1.75;
    margin-bottom: 1.5rem;
  }

  .blog-content :global(a) {
    color: #2D8B4E;
    text-decoration: underline;
    transition: color 0.15s ease;
  }

  .blog-content :global(a:hover) {
    color: #F7931E;
  }

  .blog-content :global(ul),
  .blog-content :global(ol) {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    margin-left: 1.5rem;
  }

  .blog-content :global(li) {
    margin-bottom: 0.5rem;
    color: #374151;
  }

  .blog-content :global(ul li) {
    list-style-type: disc;
  }

  .blog-content :global(ol li) {
    list-style-type: decimal;
  }

  .blog-content :global(blockquote) {
    border-left: 4px solid #2D8B4E;
    padding-left: 1.5rem;
    margin-top: 2rem;
    margin-bottom: 2rem;
    font-style: italic;
    color: #4b5563;
  }

  .blog-content :global(img) {
    border-radius: 0.75rem;
    margin-top: 2rem;
    margin-bottom: 2rem;
    width: 100%;
  }

  .blog-content :global(figure) {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }

  .blog-content :global(figcaption) {
    text-align: center;
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.5rem;
  }

  .blog-content :global(pre) {
    background-color: #111827;
    color: #f3f4f6;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .blog-content :global(code) {
    background-color: #f3f4f6;
    color: #1f2937;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  .blog-content :global(pre code) {
    background-color: transparent;
    padding: 0;
  }

  .blog-content :global(hr) {
    margin-top: 3rem;
    margin-bottom: 3rem;
    border-color: #e5e7eb;
  }

  .blog-content :global(table) {
    width: 100%;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    border-collapse: collapse;
  }

  .blog-content :global(th),
  .blog-content :global(td) {
    border: 1px solid #e5e7eb;
    padding: 0.5rem 1rem;
    text-align: left;
  }

  .blog-content :global(th) {
    background-color: #f9fafb;
    font-weight: 600;
  }
</style>
