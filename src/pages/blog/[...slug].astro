---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Section from '../../components/Section.astro';
import Container from '../../components/Container.astro';
import CTASection from '../../components/CTASection.astro';
import { useStoryblokApi } from '@storyblok/astro';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro';
import {
  formatDate,
  getCategoryLabel,
  getCategoryColors,
  getOptimizedImageUrl,
  truncateText,
  type BlogPost,
} from '../../lib/storyblok';

export async function getStaticPaths() {
  const storyblokApi = useStoryblokApi();

  try {
    const { data } = await storyblokApi.get('cdn/stories', {
      version: import.meta.env.DEV ? 'draft' : 'published',
      starts_with: 'blog/',
      is_startpage: false,
    });

    return data.stories.map((story: BlogPost) => ({
      params: { slug: story.slug.replace('blog/', '') },
      props: { story },
    }));
  } catch {
    // Return empty array if no stories exist or API is unavailable
    return [];
  }
}

interface Props {
  story: BlogPost;
}

const { story } = Astro.props;

// Fetch related posts (same category)
const storyblokApi = useStoryblokApi();
let relatedPosts: BlogPost[] = [];

try {
  const { data: relatedData } = await storyblokApi.get('cdn/stories', {
    version: import.meta.env.DEV ? 'draft' : 'published',
    starts_with: 'blog/',
    is_startpage: false,
    filter_query: {
      category: { in: story.content.category },
    },
    per_page: 4,
    sort_by: 'content.publish_date:desc',
  });

  relatedPosts = (relatedData.stories as BlogPost[])
    .filter(post => post.uuid !== story.uuid)
    .slice(0, 3);
} catch {
  relatedPosts = [];
}

const categoryColors = getCategoryColors(story.content.category);
---

<BaseLayout
  title={story.content.title}
  description={story.content.excerpt}
>
  <!-- Back to blog link -->
  <Section background="white" padding="sm">
    <Container>
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-gray-600 hover:text-[#2D8B4E] transition-colors font-medium"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Blog
      </a>
    </Container>
  </Section>

  <!-- Blog Post Content -->
  <StoryblokComponent blok={story.content} />

  <!-- Related Posts -->
  {relatedPosts.length > 0 && (
    <Section background="gray" padding="lg">
      <Container>
        <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">Related Posts</h2>
        <div class="grid md:grid-cols-3 gap-8">
          {relatedPosts.map((post) => {
            const colors = getCategoryColors(post.content.category);
            const postSlug = post.slug.replace('blog/', '');
            return (
              <article class="blog-card group animate-on-scroll">
                <a href={`/blog/${postSlug}`} class="block relative aspect-[16/10] overflow-hidden rounded-t-2xl">
                  {post.content.featured_image?.filename ? (
                    <img
                      src={getOptimizedImageUrl(post.content.featured_image.filename, { width: 400 })}
                      alt={post.content.featured_image.alt || post.content.title}
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                    />
                  ) : (
                    <div class="w-full h-full bg-gradient-to-br from-emerald-100 to-emerald-200 flex items-center justify-center">
                      <svg class="w-12 h-12 text-emerald-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                    </div>
                  )}
                  <span class={`absolute top-3 left-3 px-2.5 py-1 rounded-full text-xs font-semibold ${colors.bg} ${colors.text}`}>
                    {getCategoryLabel(post.content.category)}
                  </span>
                </a>
                <div class="p-5 bg-white rounded-b-2xl">
                  <time datetime={post.content.publish_date} class="text-sm text-gray-500">
                    {formatDate(post.content.publish_date)}
                  </time>
                  <h3 class="mt-2">
                    <a
                      href={`/blog/${postSlug}`}
                      class="text-lg font-bold text-gray-900 hover:text-[#2D8B4E] transition-colors line-clamp-2"
                    >
                      {post.content.title}
                    </a>
                  </h3>
                  <p class="mt-2 text-gray-600 text-sm line-clamp-2">
                    {truncateText(post.content.excerpt, 100)}
                  </p>
                </div>
              </article>
            );
          })}
        </div>
        <div class="text-center mt-10">
          <a
            href="/blog"
            class="inline-flex items-center gap-2 px-6 py-3 bg-white border-2 border-[#2D8B4E] text-[#2D8B4E] font-bold rounded-full hover:bg-[#2D8B4E] hover:text-white transition-all duration-300 shadow-lg hover:shadow-xl"
          >
            View All Posts
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>
      </Container>
    </Section>
  )}

  <!-- CTA Section -->
  <CTASection
    title="Make an Impact Today"
    subtitle="Your support helps us continue our mission of creating pathways out of poverty for communities around the world."
    icon="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
    primaryButtonText="Donate Now"
    primaryButtonLink="/donate"
    secondaryButtonText="Join a Trip"
    secondaryButtonLink="/get-involved/trips"
  />
</BaseLayout>

<style>
  /* Blog card */
  .blog-card {
    background: white;
    border-radius: 1rem;
    overflow: hidden;
    border: 1px solid rgba(45, 139, 78, 0.1);
    transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
  }

  .blog-card:hover {
    transform: translateY(-8px);
    border-color: rgba(45, 139, 78, 0.2);
    box-shadow: 0 20px 60px rgba(45, 139, 78, 0.1);
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
