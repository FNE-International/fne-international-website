---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Section from '../../components/Section.astro';
import Container from '../../components/Container.astro';
import CTASection from '../../components/CTASection.astro';
import {
  formatDate,
  getCategoryLabel,
  getCategoryColors,
  truncateText,
  getRelatedPosts,
} from '../../lib/blog';

// Generate static paths for all blog posts
export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Get related posts
const relatedPosts = await getRelatedPosts(post.slug, post.data.category, 3);

const categoryColors = getCategoryColors(post.data.category);
---

<BaseLayout
  title={post.data.title}
  description={post.data.excerpt}
  breadcrumbs={[{ label: 'Blog', href: '/blog' }, { label: post.data.title }]}
>
  <!-- Blog Post Content -->
  <Section background="white" padding="md">
    <Container size="md">
      <!-- Back to blog link -->
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-gray-600 hover:text-[#2D8B4E] transition-colors font-medium mb-8"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Blog
      </a>

      <article class="blog-post">
        <!-- Header -->
        <header class="mb-8">
          <div class="flex items-center gap-3 mb-4">
            <span class={`px-3 py-1 rounded-full text-xs font-semibold ${categoryColors.bg} ${categoryColors.text}`}>
              {getCategoryLabel(post.data.category)}
            </span>
            <time datetime={post.data.publishDate} class="text-sm text-gray-500">
              {formatDate(post.data.publishDate)}
            </time>
          </div>

          <h1 class="text-3xl sm:text-4xl md:text-5xl font-black text-gray-900 mb-4 leading-tight">
            {post.data.title}
          </h1>

          <p class="text-lg text-gray-600 mb-6">
            {post.data.excerpt}
          </p>

          <div class="flex items-center gap-3 pb-6 border-b border-gray-200">
            <div class="w-10 h-10 rounded-full bg-[#2D8B4E] flex items-center justify-center text-white font-semibold">
              {post.data.author?.charAt(0) || 'A'}
            </div>
            <div>
              <div class="font-semibold text-gray-900">{post.data.author}</div>
            </div>
          </div>
        </header>

        <!-- Featured Image -->
        {post.data.featuredImage && (
          <div class="mb-10 rounded-2xl overflow-hidden">
            <img
              src={post.data.featuredImage}
              alt={post.data.featuredImageAlt || post.data.title}
              class="w-full h-auto"
            />
          </div>
        )}

        <!-- Content -->
        <div class="prose prose-lg max-w-none">
          <Content />
        </div>
      </article>
    </Container>
  </Section>

  <!-- Related Posts -->
  {relatedPosts.length > 0 && (
    <Section background="gray" padding="lg">
      <Container>
        <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">Related Posts</h2>
        <div class="grid md:grid-cols-3 gap-8">
          {relatedPosts.map((relatedPost) => {
            const colors = getCategoryColors(relatedPost.data.category);
            return (
              <article class="blog-card group animate-on-scroll">
                <a href={`/blog/${relatedPost.slug}`} class="block relative aspect-[16/10] overflow-hidden rounded-t-2xl">
                  {relatedPost.data.featuredImage ? (
                    <img
                      src={relatedPost.data.featuredImage}
                      alt={relatedPost.data.featuredImageAlt || relatedPost.data.title}
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                    />
                  ) : (
                    <div class="w-full h-full bg-gradient-to-br from-emerald-100 to-emerald-200 flex items-center justify-center">
                      <svg class="w-12 h-12 text-emerald-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                    </div>
                  )}
                  <span class={`absolute top-3 left-3 px-2.5 py-1 rounded-full text-xs font-semibold ${colors.bg} ${colors.text}`}>
                    {getCategoryLabel(relatedPost.data.category)}
                  </span>
                </a>
                <div class="p-5 bg-white rounded-b-2xl">
                  <time datetime={relatedPost.data.publishDate} class="text-sm text-gray-500">
                    {formatDate(relatedPost.data.publishDate)}
                  </time>
                  <h3 class="mt-2">
                    <a
                      href={`/blog/${relatedPost.slug}`}
                      class="text-lg font-bold text-gray-900 hover:text-[#2D8B4E] transition-colors line-clamp-2"
                    >
                      {relatedPost.data.title}
                    </a>
                  </h3>
                  <p class="mt-2 text-gray-600 text-sm line-clamp-2">
                    {truncateText(relatedPost.data.excerpt, 100)}
                  </p>
                </div>
              </article>
            );
          })}
        </div>
        <div class="text-center mt-10">
          <a
            href="/blog"
            class="inline-flex items-center gap-2 px-6 py-3 bg-white border-2 border-[#2D8B4E] text-[#2D8B4E] font-bold rounded-full hover:bg-[#2D8B4E] hover:text-white transition-all duration-300 shadow-lg hover:shadow-xl"
          >
            View All Posts
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>
      </Container>
    </Section>
  )}

  <!-- CTA Section -->
  <CTASection
    title="Make an Impact Today"
    subtitle="Your support helps us continue our mission of creating pathways out of poverty for communities around the world."
    icon="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
    primaryButtonText="Donate Now"
    primaryButtonLink="/donate"
    secondaryButtonText="Join a Trip"
    secondaryButtonLink="/get-involved/trips"
  />
</BaseLayout>

<style>
  /* Blog card */
  .blog-card {
    background: white;
    border-radius: 1rem;
    overflow: hidden;
    border: 1px solid rgba(45, 139, 78, 0.1);
    transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
  }

  .blog-card:hover {
    transform: translateY(-8px);
    border-color: rgba(45, 139, 78, 0.2);
    box-shadow: 0 20px 60px rgba(45, 139, 78, 0.1);
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Prose styling for blog content */
  .prose {
    color: #374151;
    line-height: 1.8;
  }

  .prose h2 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #111827;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }

  .prose h3 {
    font-size: 1.375rem;
    font-weight: 600;
    color: #111827;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .prose p {
    margin-bottom: 1.5rem;
  }

  .prose ul,
  .prose ol {
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
  }

  .prose li {
    margin-bottom: 0.5rem;
  }

  .prose ul li {
    list-style-type: disc;
  }

  .prose ol li {
    list-style-type: decimal;
  }

  .prose a {
    color: #2D8B4E;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .prose a:hover {
    color: #F7931E;
  }

  .prose strong {
    font-weight: 600;
    color: #111827;
  }

  .prose blockquote {
    border-left: 4px solid #2D8B4E;
    padding-left: 1.5rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #6b7280;
  }

  .prose img {
    border-radius: 0.75rem;
    margin: 2rem 0;
  }

  .prose code {
    background: #f3f4f6;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }

  .prose pre {
    background: #1f2937;
    color: #e5e7eb;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.5rem 0;
  }

  .prose pre code {
    background: transparent;
    padding: 0;
  }
</style>
