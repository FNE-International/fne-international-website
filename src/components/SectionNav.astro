---
interface Props {
  sections: Array<{
    id: string;
    label: string;
    icon?: string;
  }>;
}

const { sections } = Astro.props;
---

<nav class="section-nav" data-section-nav aria-label="Page sections">
  {sections.map((section) => (
    <a
      href={`#${section.id}`}
      class="section-nav-item"
      data-section-link={section.id}
    >
      <span class="section-nav-dot"></span>
      <span class="section-nav-label">{section.label}</span>
    </a>
  ))}
</nav>

<script>
  function initSectionNav() {
    const nav = document.querySelector('[data-section-nav]') as HTMLElement | null;
    if (!nav) return;

    const links = nav.querySelectorAll('[data-section-link]');
    const sections: { id: string; element: HTMLElement }[] = [];

    // Collect all sections that have matching IDs
    links.forEach((link) => {
      const id = link.getAttribute('data-section-link');
      if (id) {
        const element = document.getElementById(id);
        if (element) {
          sections.push({ id, element });
        }
      }
    });

    // Show/hide nav based on scroll position
    function updateNavVisibility() {
      const scrollY = window.scrollY;
      const showThreshold = 500;

      if (scrollY > showThreshold) {
        nav.classList.add('visible');
      } else {
        nav.classList.remove('visible');
      }
    }

    // Update active state based on scroll position
    function updateActiveSection() {
      const scrollPosition = window.scrollY + window.innerHeight / 3;

      let activeId = sections[0]?.id;

      for (const section of sections) {
        const rect = section.element.getBoundingClientRect();
        const top = rect.top + window.scrollY;

        if (scrollPosition >= top) {
          activeId = section.id;
        }
      }

      // Update link states
      links.forEach((link) => {
        const linkId = link.getAttribute('data-section-link');
        if (linkId === activeId) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    }

    function onScroll() {
      updateNavVisibility();
      updateActiveSection();
    }

    // Initial update
    onScroll();

    // Update on scroll with throttling
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          onScroll();
          ticking = false;
        });
        ticking = true;
      }
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initSectionNav);

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initSectionNav);
</script>

<style>
  .section-nav {
    position: fixed;
    left: 1.5rem;
    top: 50%;
    transform: translateY(-50%);
    z-index: 40;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.4s ease, visibility 0.4s ease;
  }

  .section-nav.visible {
    opacity: 1;
    visibility: visible;
  }

  /* Hide on mobile and tablets */
  @media (max-width: 1024px) {
    .section-nav {
      display: none;
    }
  }

  .section-nav-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .section-nav-item:hover .section-nav-label {
    color: #2D8B4E;
  }

  .section-nav-item:hover .section-nav-dot {
    background: rgba(45, 139, 78, 0.5);
    transform: scale(1.3);
  }

  .section-nav-item.active .section-nav-label {
    color: #2D8B4E;
    font-weight: 600;
  }

  .section-nav-item.active .section-nav-dot {
    background: #2D8B4E;
    transform: scale(1.3);
  }

  .section-nav-label {
    font-size: 0.6875rem;
    color: rgba(0, 0, 0, 0.4);
    white-space: nowrap;
    transition: all 0.2s ease;
  }

  .section-nav-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.15);
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
</style>
